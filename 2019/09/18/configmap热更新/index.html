<!DOCTYPE html>



  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css">







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="容器,">










<meta name="description" content="简介configmap是Kubernetes中的一个资源对象，用来存储键值对数据，往往是配置信息，可以理解为整个命名空间的/etc目录。 configmap可用于环境变量，命令行参数和挂载数据卷。值得一提的是，configmap还具备热更新的功能，接下来就让我们实践下吧。 热更新实践首先，创建一个测试的configmap： 12345678# kubectl create -f test-cm.y">
<meta name="keywords" content="容器">
<meta property="og:type" content="article">
<meta property="og:title" content="configmap热更新">
<meta property="og:url" content="https://staight.github.io/2019/09/18/configmap热更新/index.html">
<meta property="og:site_name" content="staight">
<meta property="og:description" content="简介configmap是Kubernetes中的一个资源对象，用来存储键值对数据，往往是配置信息，可以理解为整个命名空间的/etc目录。 configmap可用于环境变量，命令行参数和挂载数据卷。值得一提的是，configmap还具备热更新的功能，接下来就让我们实践下吧。 热更新实践首先，创建一个测试的configmap： 12345678# kubectl create -f test-cm.y">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2019-10-02T17:49:48.401Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="configmap热更新">
<meta name="twitter:description" content="简介configmap是Kubernetes中的一个资源对象，用来存储键值对数据，往往是配置信息，可以理解为整个命名空间的/etc目录。 configmap可用于环境变量，命令行参数和挂载数据卷。值得一提的是，configmap还具备热更新的功能，接下来就让我们实践下吧。 热更新实践首先，创建一个测试的configmap： 12345678# kubectl create -f test-cm.y">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://staight.github.io/2019/09/18/configmap热更新/">





  <title>configmap热更新 | staight</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">staight</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br>
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>
            
            Archives
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sundries">
          <a href="/sundries/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-calendar"></i> <br>
            
            Sundries
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://staight.github.io/2019/09/18/configmap热更新/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="staight">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="staight">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">configmap热更新</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2019-09-18T09:55:02+08:00">
                2019-09-18
              </time>
            

            
              <span class="post-meta-divider">|</span>
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-check-o"></i>
              </span>
              
                <span class="post-meta-item-text">Post modified&#58;</span>
              
              <time title="Post modified" itemprop="dateModified" datetime="2019-10-03T01:49:48+08:00">
                2019-10-03
              </time>
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>configmap是Kubernetes中的一个资源对象，用来存储键值对数据，往往是配置信息，可以理解为整个命名空间的<code>/etc</code>目录。</p>
<p>configmap可用于环境变量，命令行参数和挂载数据卷。值得一提的是，configmap还具备热更新的功能，接下来就让我们实践下吧。</p>
<h2 id="热更新实践"><a href="#热更新实践" class="headerlink" title="热更新实践"></a>热更新实践</h2><p>首先，创建一个测试的configmap：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f test-cm.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line"><span class="attr">  a:</span> <span class="string">"1"</span></span><br></pre></td></tr></table></figure>

<p>创建后，可以使用edit，apply或patch命令修改a的值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl patch cm test -p &apos;&#123;&quot;data&quot;:&#123;&quot;a&quot;:&quot;2&quot;&#125;&#125;&apos;</span><br></pre></td></tr></table></figure>

<p>接下来，通过环境变量，命令行参数以及数据卷挂载这三种方式测试configmap的热更新效果。</p>
<h3 id="环境变量"><a href="#环境变量" class="headerlink" title="环境变量"></a>环境变量</h3><p>创建alpine容器，并使用test-cm作为环境变量：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f test-pod.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">alpine</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">alpine</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">[</span> <span class="string">"/bin/sleep"</span><span class="string">,</span> <span class="string">"3600"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      envFrom:</span></span><br><span class="line"><span class="attr">        - configMapRef:</span></span><br><span class="line"><span class="attr">            name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>查看test-pod的环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- env | grep a=</span><br><span class="line">a=1</span><br></pre></td></tr></table></figure>

<p>修改configmap后，再次查看test-pod的环境变量：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- env | grep a=</span><br><span class="line">a=1</span><br></pre></td></tr></table></figure>

<p>不变，说明configmap无法热更新环境变量。</p>
<h3 id="命令行参数"><a href="#命令行参数" class="headerlink" title="命令行参数"></a>命令行参数</h3><p>命令行参数本质上是环境变量的一种特殊情况。设置好环境变量后，在命令行参数中添加<code>$(ENV)</code>即可获取到环境变量。</p>
<p>configmap无法热更新环境变量，而命令行参数只在容器启动时使用，因此configmap无法热更新命令行参数，也没有必要。</p>
<h3 id="挂载数据卷"><a href="#挂载数据卷" class="headerlink" title="挂载数据卷"></a>挂载数据卷</h3><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl create -f test-pod.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">alpine</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">alpine</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">[</span> <span class="string">"/bin/sleep"</span><span class="string">,</span> <span class="string">"3600"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">        mountPath:</span> <span class="string">/test</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">      configMap:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>查看挂载的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- cat /test/a</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>修改test-cm，等待一分钟后再次查看挂载的文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- cat /test/a</span><br><span class="line">2</span><br></pre></td></tr></table></figure>

<p>热更新成功。</p>
<h3 id="挂载数据卷（子路径）"><a href="#挂载数据卷（子路径）" class="headerlink" title="挂载数据卷（子路径）"></a>挂载数据卷（子路径）</h3><p>默认情况下，挂载数据卷方式将configmap挂载至一个文件夹，其中键为文件名，值为内容。</p>
<p>有时Pod需要多次挂载，每个挂载点只需要数据卷中的单个文件/文件夹，这个时候就需要使用子路径了。</p>
<p>如下，将数据卷中的a文件挂载至/test下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubectl apply -f test-pod.yml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line"><span class="attr">  name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line"><span class="attr">  containers:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">alpine</span></span><br><span class="line"><span class="attr">      image:</span> <span class="string">alpine</span></span><br><span class="line"><span class="attr">      command:</span> <span class="string">[</span> <span class="string">"/bin/sleep"</span><span class="string">,</span> <span class="string">"3600"</span><span class="string">]</span></span><br><span class="line"><span class="attr">      volumeMounts:</span></span><br><span class="line"><span class="attr">      - name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">        mountPath:</span> <span class="string">/test</span></span><br><span class="line"><span class="attr">        subPath:</span> <span class="string">a</span></span><br><span class="line"><span class="attr">  volumes:</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">      configMap:</span></span><br><span class="line"><span class="attr">        name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">  restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>查看test文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- cat /test</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>修改test-cm后，再次查看test文件内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@node1 test]# kubectl exec test -- cat /test</span><br><span class="line">1</span><br></pre></td></tr></table></figure>

<p>没有变化，说明configmap无法热更新子路径方式的挂载数据卷。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>更新configmap后：</p>
<ul>
<li>使用该configmap的环境变量和命令行参数不会触发更新。</li>
<li>使用该configmap挂载的数据卷会触发更新。</li>
<li>如果使用子路径方式挂载的数据卷，将不会触发更新。</li>
</ul>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>据官网所说，kubelet在每个同步周期中检查configmap是否更新，其获取方式分为两种，分别为从apiserver获取以及从本地缓存获取。在默认情况下，本地缓存更新周期和同步周期均为1分钟。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">When a ConfigMap already being consumed in a volume is updated, projected keys are eventually updated as well. Kubelet is checking whether the mounted ConfigMap is fresh on every periodic sync. However, it is using its local ttl-based cache for getting the current value of the ConfigMap. As a result, the total delay from the moment when the ConfigMap is updated to the moment when new keys are projected to the pod can be as long as kubelet sync period (1 minute by default) + ttl of ConfigMaps cache (1 minute by default) in kubelet.</span><br></pre></td></tr></table></figure>

<h3 id="configmap-manager-go"><a href="#configmap-manager-go" class="headerlink" title="configmap_manager.go"></a>configmap_manager.go</h3><p>首先看<code>pkg/kubelet/configmap/configmap_manager.go</code>，该文件定义了<code>Manager</code>接口，提供了Kubelet管理configmap的方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Manager interface provides methods for Kubelet to manage ConfigMap.</span></span><br><span class="line"><span class="keyword">type</span> Manager <span class="keyword">interface</span> &#123;</span><br><span class="line">	<span class="comment">// Get configmap by configmap namespace and name.</span></span><br><span class="line">	GetConfigMap(namespace, name <span class="keyword">string</span>) (*v1.ConfigMap, error)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// WARNING: Register/UnregisterPod functions should be efficient,</span></span><br><span class="line">	<span class="comment">// i.e. should not block on network operations.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// RegisterPod registers all configmaps from a given pod.</span></span><br><span class="line">	RegisterPod(pod *v1.Pod)</span><br><span class="line"></span><br><span class="line">	<span class="comment">// UnregisterPod unregisters configmaps from a given pod that are not</span></span><br><span class="line">	<span class="comment">// used by any other registered pod.</span></span><br><span class="line">	UnregisterPod(pod *v1.Pod)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结构体<code>configMapManager</code>实现了该接口，其<code>GetConfigMap</code>方法用于获取configmap：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *configMapManager)</span> <span class="title">GetConfigMap</span><span class="params">(namespace, name <span class="keyword">string</span>)</span> <span class="params">(*v1.ConfigMap, error)</span></span> &#123;</span><br><span class="line">	object, err := c.manager.GetObject(namespace, name)</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> configmap, ok := object.(*v1.ConfigMap); ok &#123;</span><br><span class="line">		<span class="keyword">return</span> configmap, <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unexpected object type: %v"</span>, object)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>函数<code>NewCachingConfigMapManager</code>用于初始化configMapManager：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewCachingConfigMapManager creates a manager that keeps a cache of all configmaps</span></span><br><span class="line"><span class="comment">// necessary for registered pods.</span></span><br><span class="line"><span class="comment">// It implement the following logic:</span></span><br><span class="line"><span class="comment">// - whenever a pod is create or updated, the cached versions of all configmaps</span></span><br><span class="line"><span class="comment">//   are invalidated</span></span><br><span class="line"><span class="comment">// - every GetObject() call tries to fetch the value from local cache; if it is</span></span><br><span class="line"><span class="comment">//   not there, invalidated or too old, we fetch it from apiserver and refresh the</span></span><br><span class="line"><span class="comment">//   value in cache; otherwise it is just fetched from cache</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCachingConfigMapManager</span><span class="params">(kubeClient clientset.Interface, getTTL manager.GetObjectTTLFunc)</span> <span class="title">Manager</span></span> &#123;</span><br><span class="line">	getConfigMap := <span class="function"><span class="keyword">func</span><span class="params">(namespace, name <span class="keyword">string</span>, opts metav1.GetOptions)</span> <span class="params">(runtime.Object, error)</span></span> &#123;</span><br><span class="line">		<span class="keyword">return</span> kubeClient.CoreV1().ConfigMaps(namespace).Get(name, opts)</span><br><span class="line">	&#125;</span><br><span class="line">	configMapStore := manager.NewObjectStore(getConfigMap, clock.RealClock&#123;&#125;, getTTL, defaultTTL)</span><br><span class="line">	<span class="keyword">return</span> &amp;configMapManager&#123;</span><br><span class="line">		manager: manager.NewCacheBasedManager(configMapStore, getConfigMapNames),</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意注释，GetObject()函数尝试从本地缓存获取configmap，如果没有，不合法或已过期，则从apiserver获取并刷新缓存。</p>
<h3 id="kubelet-go"><a href="#kubelet-go" class="headerlink" title="kubelet.go"></a>kubelet.go</h3><p>再转到<code>pkg/kubelet/kubelet.go</code>文件，该文件负责kubelet的初始化工作。其调用了NewCachingConfigMapManager函数用于初始化configMapManager：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMainKubelet</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="keyword">switch</span> kubeCfg.ConfigMapAndSecretChangeDetectionStrategy &#123;</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.WatchChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewWatchingSecretManager(kubeDeps.KubeClient)</span><br><span class="line">		configMapManager = configmap.NewWatchingConfigMapManager(kubeDeps.KubeClient)</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.TTLCacheChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewCachingSecretManager(</span><br><span class="line">			kubeDeps.KubeClient, manager.GetObjectTTLFromNodeFunc(klet.GetNode))</span><br><span class="line">		configMapManager = configmap.NewCachingConfigMapManager(</span><br><span class="line">			kubeDeps.KubeClient, manager.GetObjectTTLFromNodeFunc(klet.GetNode))</span><br><span class="line">	<span class="keyword">case</span> kubeletconfiginternal.GetChangeDetectionStrategy:</span><br><span class="line">		secretManager = secret.NewSimpleSecretManager(kubeDeps.KubeClient)</span><br><span class="line">		configMapManager = configmap.NewSimpleConfigMapManager(kubeDeps.KubeClient)</span><br><span class="line">	<span class="keyword">default</span>:</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"unknown configmap and secret manager mode: %v"</span>, kubeCfg.ConfigMapAndSecretChangeDetectionStrategy)</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>并在初始化<code>podManager</code>时与configMapManager绑定，其在更新和删除Pod时会检查并更新configmap状态：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// podManager is also responsible for keeping secretManager and configMapManager contents up-to-date.</span></span><br><span class="line">klet.podManager = kubepod.NewBasicPodManager(kubepod.NewBasicMirrorClient(klet.kubeClient), secretManager, configMapManager, checkpointManager)</span><br></pre></td></tr></table></figure>

<p><code>volumeManager</code>初始化时绑定了podManager，在更新configmap状态后，kubelet通过<code>volumeManager</code>更新Pod的数据卷：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMainKubelet</span><span class="params">(...)</span></span> &#123;</span><br><span class="line">    ...</span><br><span class="line">	<span class="comment">// VolumeManager runs a set of asynchronous loops that figure out which</span></span><br><span class="line">	<span class="comment">// volumes need to be attached/mounted/unmounted/detached based on the pods</span></span><br><span class="line">	<span class="comment">// scheduled on this node and makes it so.</span></span><br><span class="line">	klet.volumeManager = volumemanager.NewVolumeManager(</span><br><span class="line">		kubeCfg.EnableControllerAttachDetach,</span><br><span class="line">		nodeName,</span><br><span class="line">		klet.podManager,</span><br><span class="line">		klet.statusManager,</span><br><span class="line">		klet.kubeClient,</span><br><span class="line">		klet.volumePluginMgr,</span><br><span class="line">		klet.containerRuntime,</span><br><span class="line">		kubeDeps.Mounter,</span><br><span class="line">		kubeDeps.HostUtil,</span><br><span class="line">		klet.getPodsDir(),</span><br><span class="line">		kubeDeps.Recorder,</span><br><span class="line">		experimentalCheckNodeCapabilitiesBeforeMount,</span><br><span class="line">		keepTerminatedPodVolumes,</span><br><span class="line">        volumepathhandler.NewBlockVolumePathHandler())</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后使用go协程运行<code>volumeManager</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Start volume manager</span></span><br><span class="line"><span class="keyword">go</span> kl.volumeManager.Run(kl.sourcesReady, wait.NeverStop)</span><br></pre></td></tr></table></figure>

<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p>kubernetes.io: Mounted ConfigMaps are updated automatically：<a href="https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#mounted-configmaps-are-updated-automatically" target="_blank" rel="noopener">https://kubernetes.io/docs/tasks/configure-pod-container/configure-pod-configmap/#mounted-configmaps-are-updated-automatically</a></p>
<p>jimmysong.io: configmap的热更新：<a href="https://jimmysong.io/kubernetes-handbook/concepts/configmap-hot-update.html" target="_blank" rel="noopener">https://jimmysong.io/kubernetes-handbook/concepts/configmap-hot-update.html</a></p>
<p>github: kubernetes: <a href="https://github.com/kubernetes/kubernetes" target="_blank" rel="noopener">https://github.com/kubernetes/kubernetes</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/容器/" rel="tag"># 容器</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/09/16/在k8s上部署elasticsearch/" rel="next" title="在k8s上部署elasticsearch">
                <i class="fa fa-chevron-left"></i> 在k8s上部署elasticsearch
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/09/20/event日志查询工具/" rel="prev" title="event日志查询工具">
                event日志查询工具 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.png" alt="staight">
            
              <p class="site-author-name" itemprop="name">staight</p>
              <p class="site-description motion-element" itemprop="description">keep it simple and stupid</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">60</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#简介"><span class="nav-number">1.</span> <span class="nav-text">简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#热更新实践"><span class="nav-number">2.</span> <span class="nav-text">热更新实践</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#环境变量"><span class="nav-number">2.1.</span> <span class="nav-text">环境变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#命令行参数"><span class="nav-number">2.2.</span> <span class="nav-text">命令行参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#挂载数据卷"><span class="nav-number">2.3.</span> <span class="nav-text">挂载数据卷</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#挂载数据卷（子路径）"><span class="nav-number">2.4.</span> <span class="nav-text">挂载数据卷（子路径）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">3.</span> <span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码分析"><span class="nav-number">4.</span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#configmap-manager-go"><span class="nav-number">4.1.</span> <span class="nav-text">configmap_manager.go</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#kubelet-go"><span class="nav-number">4.2.</span> <span class="nav-text">kubelet.go</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考文档"><span class="nav-number">5.</span> <span class="nav-text">参考文档</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">staight</span>

  
</div>






  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Mist</a></div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
